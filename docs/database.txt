Wamble Database
================

Overview
- Backend: PostgreSQL.
- Purpose: Persist players/sessions, boards, moves, reservations, results, payouts, and predictions.
- Profiles: Each advertised profile uses its own per-thread database connection.
- Access: Runtime code reads via a small `WambleQueryService` interface and writes by enqueueing persistence intents which are flushed to the database in batches.

Connections
- Per-thread per-listener: Each listener thread opens its own DB connection using
  that profile's `db-host`, `db-user`, `db-pass`, `db-name`.
  This supports running multiple profiles against different databases in a single process.

Read Path Caching
- Token-indexed reads are cached in thread-local memory to reduce repeated DB lookups
  during hot loops (session lookup, persistent-session lookup, trust-tier lookup).
- Cache characteristics:
  - Capacity: 256 entries per cache type per runtime thread.
  - TTL: 500ms per entry.
  - Scope: thread-local; no cross-thread sharing.
- Cache entries include both successful and failure statuses (`DB_OK`, `DB_NOT_FOUND`,
  connection/exec/bad-data errors), so repeated failures are also throttled within TTL.
- Session-linking updates invalidate the persistent-session cache for correctness.

Write Batching and Transactions
- Intent flushes are applied in bounded batches (intent count and estimated payload bytes;
  see `persistence-max-intents` and `persistence-max-payload-bytes` in config).
- The selected batch is attempted inside an explicit DB transaction (`BEGIN`/`COMMIT`).
- If transactional apply fails, the runtime rolls back and retries selected intents in
  non-transactional per-intent mode, requeuing only failed intents.
- Intent selection/coalescing rules reduce redundant writes before execution:
  - Keep only the newest per key for `UPDATE_BOARD`, `UPDATE_BOARD_ASSIGNMENT_TIME`,
    `UPDATE_SESSION_LAST_SEEN`, and `REMOVE_RESERVATION`.
  - `RECORD_MOVE` and `RECORD_PAYOUT` intents are grouped and sorted for append-friendly
    write locality.
- Flush cadence is runtime-driven and can perform multiple batches per cycle when backlog
  is high.

Tables
- players
  - `id BIGSERIAL PRIMARY KEY`
  - `public_key BYTEA UNIQUE NOT NULL` (32 bytes)
  - `rating DECIMAL(10,4) NOT NULL`
  - `created_at TIMESTAMPTZ DEFAULT NOW()`

- sessions
  - `id BIGSERIAL PRIMARY KEY`
  - `token BYTEA UNIQUE NOT NULL` (16 bytes)
  - `player_id BIGINT NULL REFERENCES players(id)`
  - `trust_level INTEGER NOT NULL DEFAULT 0`
  - `created_at TIMESTAMPTZ DEFAULT NOW()`
  - `last_seen_at TIMESTAMPTZ DEFAULT NOW()`
  - Indexes: `idx_sessions_token` on `(token)`
  - Usage:
    - `trust_level` is used to filter profiles in LIST_PROFILES: only profiles with `visibility <= trust_level` are listed to the client.

- boards
  - `id BIGSERIAL PRIMARY KEY`
  - `fen VARCHAR(90) NOT NULL`
  - `status VARCHAR(16) NOT NULL` in {'ACTIVE','RESERVED','DORMANT','ARCHIVED'}
  - `created_at TIMESTAMPTZ DEFAULT NOW()`
  - `updated_at TIMESTAMPTZ DEFAULT NOW()`
  - Indexes: `idx_boards_status` on `(status)`
  - Trigger: `trigger_boards_updated_at` updates `updated_at` on update.

- moves
  - `id BIGSERIAL PRIMARY KEY`
  - `board_id BIGINT NOT NULL REFERENCES boards(id)`
  - `session_id BIGINT NOT NULL REFERENCES sessions(id)`
  - `move_uci VARCHAR(6) NOT NULL`
  - `move_number INTEGER NOT NULL`
  - `timestamp TIMESTAMPTZ DEFAULT NOW()`
  - Indexes: `(board_id)`, `(session_id)`

- reservations
  - `board_id BIGINT PRIMARY KEY REFERENCES boards(id)`
  - `session_id BIGINT NOT NULL REFERENCES sessions(id)`
  - `expires_at TIMESTAMPTZ NOT NULL`
  - Index: `idx_reservations_expires_at` on `(expires_at)`

- game_results
  - `board_id BIGINT PRIMARY KEY REFERENCES boards(id)`
  - `winning_side CHAR(1) NOT NULL` in {'w','b','d'}
  - `finished_at TIMESTAMPTZ DEFAULT NOW()`

- payouts
  - `id BIGSERIAL PRIMARY KEY`
  - `board_id BIGINT NOT NULL REFERENCES boards(id)`
  - `session_id BIGINT NOT NULL REFERENCES sessions(id)`
  - `points_awarded DECIMAL(10,4) NOT NULL`
  - `created_at TIMESTAMPTZ DEFAULT NOW()`
  - Index: `idx_payouts_session_id` on `(session_id)`

- predictions
  - `id BIGSERIAL PRIMARY KEY`
  - `board_id BIGINT NOT NULL REFERENCES boards(id)`
  - `session_id BIGINT NOT NULL REFERENCES sessions(id)`
  - `predicted_move_uci VARCHAR(6) NOT NULL`
  - `status VARCHAR(16) NOT NULL DEFAULT 'PENDING'` in {'PENDING','CORRECT','INCORRECT','EXPIRED'}
  - `created_at TIMESTAMPTZ DEFAULT NOW()`

Migrations
- 001_initial_schema.sql: creates all tables, indexes, triggers.

Trust and Visibility
- Client trust is read from `sessions.trust_level`.
- On LIST_PROFILES, the server filters advertised profiles where `profile.visibility <= sessions.trust_level` for the requesting token.
- PROFILE_INFO still returns `name;port;advertise;visibility`; no server-side gating there yet.

Operational Notes
- Multiple advertised profiles within one process may point to different databases.
- Persistence intents are applied from the runtime loop (threaded for multi-profile, inline
  in main thread for single-runtime mode).

Examples
- Promote a session to trust level 10 by hex token:
  UPDATE sessions SET trust_level = 10 WHERE token = decode('<hex>', 'hex');

References
- Config (see docs/configuration.txt): `db-host`, `db-user`, `db-pass`, `db-name`.
- Player management (see docs/player_management.txt): token creation, lookup, last-seen updates.
- Board behavior (see docs/board_behaviour.txt): board statuses and lifecycle.
- Move engine (see docs/move_engine.txt): move storage and flow.
- Scoring (see docs/scoring.txt): payouts written to `payouts`.
- Spectators (see docs/spectator_management.txt): trust gating via `sessions.trust_level`.
