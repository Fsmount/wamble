Wamble Configuration
====================

Overview
- Format: minimal Lisp-like expressions with forms and symbols.
- Top-level forms are evaluated in order.
- Use `(def name value)` to define variables.
- Use `(defprofile name ((forms...)))` to define a named profile.

Core Options (common defaults)
- `port` (int, 8888): UDP server port.
- `timeout-ms` (int, 100): Reliable send ACK timeout (ms).
- `max-retries` (int, 3): Reliable send retries.
- `max-message-size` (int, 126): Fixed message body size (informational).
- `buffer-size` (int, 65536): Socket send/recv buffer bytes.
- `max-client-sessions` (int, 1024): Client session capacity.
- `session-timeout` (int, 300): Idle session timeout (sec).
- `max-boards` / `min-boards` (int, 1024 / 4): Board pool sizing.
- `inactivity-timeout` (int, 300): Archive inactive boards (sec).
- `reservation-timeout` (int, 2): Board reservation lease (sec).
- `k-factor` (int, 32): Elo K factor.
- `default-rating` (int, 1200): Starting rating for new players.
- `max-players` (int, 1024): Player capacity.
- `token-expiration` (int, 86400): Token TTL (sec).
- `max-pot` (double, 20.0): Scoring pot cap per board.
- `max-moves-per-board` (int, 1000): Move history cap per board.
- `max-contributors` (int, 100): Max contributors per board for scoring.
- `new-player-early-phase-mult` (double, 2.0): Payout multiplier for new players in the early game.
- `new-player-mid-phase-mult` (double, 1.0): Payout multiplier for new players in the mid game.
- `new-player-end-phase-mult` (double, 0.5): Payout multiplier for new players in the late game.
- `experienced-player-early-phase-mult` (double, 0.5): Payout multiplier for experienced players in the early game.
- `experienced-player-mid-phase-mult` (double, 1.0): Payout multiplier for experienced players in the mid game.
- `experienced-player-end-phase-mult` (double, 2.0): Payout multiplier for experienced players in the late game.
- `db-host`, `db-user`, `db-pass`, `db-name` (string, defaults
  localhost/wamble/wamble/wamble): Database connection.
- `admin-trust-level` (int, -1): Optional admin threshold. If set to a non-negative trust tier, sessions with `trust >= admin-trust-level` can do admin things. 
Database Connections
- Each profile listener runs in its own thread and opens its own DB connection
  using that profile's `db-host`, `db-user`, `db-pass`, `db-name`.
- `select-timeout-usec` (int, 100000): Main loop select timeout (usec).
- `cleanup-interval-sec` (int, 60): Session cleanup cadence.
- `max-token-attempts` / `max-token-local-attempts` (int, 1000 / 100): Token
  generation limits.
Spectator Settings
- `max-spectators` (int, 1024; -1 for no cap): Capacity limit for focused spectators at the server. Admins (see `admin-trust-level`) may bypass this cap.
- `spectator-visibility` (int, 0): Minimum trust tier required to spectate (summary or focus). Requests below this threshold are rejected.
- `spectator-summary-hz` (int, 2): Target max update rate (per second) for summary mode. Best-effort; updates are sent over UDP and may be batched by the main loop cadence.
- `spectator-focus-hz` (int, 20): Target max update rate (per second) for focused board updates. Best-effort over UDP.
- `spectator-max-focus-per-session` (int, 1): Focus enable switch. Current implementation supports 0 (disabled) or 1 (single focus). Values >1 behave as 1.
- `spectator-summary-mode` (string, "changes"): Summary filtering mode:
  - `full`: send all ACTIVE+RESERVED boards.
  - `changes`: send only boards whose state changed since the last summary tick.

Logging Verbosity
- `log-level` (int, 0..4; default 3=INFO): Global verbosity
  (0=FATAL, 1=ERROR, 2=WARN, 3=INFO, 4=DEBUG).
  Per-module log levels are not supported at this time.

Builtins for Computed and Conditional Values
- Arithmetic: `(+ a b ...)`, `(- a [b ...])`, `(* a b ...)`, `(/ a b ...)`.
- Comparison: `(= a b)` for ints, floats, or strings.
- Conditionals: `(if cond then-expr else-expr?)`.
- Environment access: `(getenv "VAR")` returns a string (empty if unset).
- Sequencing: `(do expr1 expr2 ... exprN)` evaluates in order, returns last.
- Quoting: `(quote expr)` returns `expr` without evaluating it.

Functions and Macros
- Define a function: `(defn name (arg1 arg2 ...) body...)`
  - Lexically scoped; arguments are evaluated before binding.
  - Returns the value of the last body form.
- Define a macro: `(defmacro name (arg1 arg2 ...) body...)`
  - Arguments are NOT evaluated; they are raw syntax (AST) values.
  - Body should produce an expanded form which is then evaluated at call-site.
- Example helper function:
  `(defn port-for (base offset) (+ base offset))`
  `(def port (port-for 8800 12)) ; => 8812`
- Example macro for common profile shape:
  `(defmacro simple-profile (pname pport)
     (do (defprofile pname ((def port pport)
                             (def advertise 1)
                             (def visibility 0)))))`
  `(simple-profile canary 8891)`

Examples: Functions and Macros
--------------------------------
- Helper function for ports and timeouts:
  
  `(defn port-for (base offset) (+ base offset))`
  `(defn ms->sec (ms) (/ ms 1000))`
  `(def port (port-for 8800 42))           ; => 8842`
  `(def session-timeout (ms->sec 250000))  ; => 250`

- Macro to DRY up common profiles:
  
  `(defmacro simple-profile (name p)
     (do (defprofile name ((def port p)
                            (def advertise 1)
                            (def visibility 0)
                            (def log-level 3)))))`
  
  `(simple-profile default-a 8888)`
  `(simple-profile default-b 8889)`

- Macro with inheritance (wraps defprofile :inherits):
  
  `(defmacro inherit (new base p)
     (do (defprofile new :inherits base ((def port p)))))`
  
  `(defprofile base ((def db-name "wamble_base") (def log-level 2)))`
  `(inherit canary base 8891)`

- Example of toggling global verbosity via helpers:
  
  `(defn dbg-if (flag) (if (= flag 1) 4 3))`
  `(def debug-enabled 1)`
  `(def log-level (dbg-if debug-enabled))  ; 4=DEBUG when enabled, else 3=INFO`

- Quoting and sequencing utilities:
  
  `(do (def tmp 1) (def tmp (+ tmp 1)) tmp)  ; => 2`
  `(def quoted (quote (def some-setting 1))) ; not evaluated`
  `quoted` evaluates to the AST of `(def some-setting 1)`.

Examples
- Computed value:
  `(def session-timeout (* 3 timeout-ms))`
- Conditional by env:
  `(def db-host (if (= (getenv "WAMBLE_ENV") "production") "prod.db" "localhost"))`
- Global verbosity examples:
  `(def log-level 3)`
  `(defn dbg (flag) (if (= flag 1) 4 3))`
  `(def debug 0)`
  `(def log-level (dbg debug))`

Profiles
- Define a profile with grouped overrides:
  `(defprofile test ((def port 8890) (def db-name "wamble_test") (def log-level 4)))`
- Metadata inside a profile:
  - `advertise` (int 0/1, default 0): Whether to advertise/offer this profile
    to clients.
  - `visibility` (int, default 0): Minimum trust tier required to see this profile in
    LIST_PROFILES. The server compares this to `sessions.trust_level` for the
    requesting token.
  - `db-isolated` (int 0/1): If 1, this profile must not share the same
    database (host/user/name) with any other advertised profile that also
    sets `db-isolated=1`. Conflicts cause startup to fail with a fatal error.
  
- Explicit inheritance:
  `(defprofile canary :inherits base ((def port 8891) (def log-level 4)))`
  Inherits all values from profile `base`, then applies listed overrides.

Macros
- Optional helpers like `simple-profile` can reduce repetition; there is no
  db-root concept.

Defaults and Precedence
- Unspecified options use the compiled-in defaults listed above.
- Top-level `def` sets process-wide defaults; `defprofile` overrides values
  for that profile only.
- Inheritance copies all base values and metadata (including `advertise`,
  `visibility`, and `db-isolated`) unless overridden in the child profile.

Running with a Profile
- Pass `--profile <name>` to apply that profile at startup.
- Multiple profiles can be defined; the server exposes them via config APIs
  for multi-profile runtime integrations.

Concurrent Profiles
- When multiple profiles are defined with `advertise=1`, the server starts
  one listener per profile on its configured `port`, enforcing unique ports.
- On SIGHUP, config reloads and listeners are reconciled: added/removed/updated
  profiles are started/stopped/restarted accordingly.
- Validation is strict: if two advertised profiles conflict (duplicate ports),
  the server terminates with a fatal error.
- DB model: Profiles may use distinct DB settings; each listener thread manages
  its own connection. If two advertised profiles both set `db-isolated=1` they
  must not point to the same DB.

Visibility and Discovery
- LIST_PROFILES returns only advertised profiles whose `visibility` is less
  than or equal to the requesting client's trust tier,
  `sessions.trust_level` (see database docs). PROFILE_INFO remains available
  and returns `name;port;advertise;visibility`.

Notes
- Strings must be quoted. Numbers parse as integers unless they contain a dot.
- Unknown names in `def` are ignored by the engine unless referenced by code; 
  they remain available for user logic inside the config.
